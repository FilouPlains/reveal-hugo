{{ $reveal_location := $.Param "reveal_hugo.reveal_cdn" | default "reveal-js" }}

{{ $plugins := slice }}
{{ if $.Param "reveal_hugo.load_default_plugins" | default true }}
  {{ $default_plugins := slice (dict "name"   "marked"
                                     "source" "plugin/markdown/marked.js")
                               (dict "name"   "RevealMarkdown"
                                     "source" "plugin/markdown/markdown.js")
                               (dict "name"   "RevealHighlight"
                                     "source" "plugin/highlight/highlight.js")
                               (dict "name"   "zoom"
                                     "source" "plugin/zoom-js/zoom.js") }}
  {{ $plugins = $plugins | append $default_plugins }}
  <!-- always use local version of the notes plugin since HTML file it requires isn't on CDN -->
  {{ $plugins = $plugins | append (dict "name" "RevealNotes" "source" "reveal-js/plugin/notes/notes.js" "local" true) }}
{{ end }}

{{/*  load custom plugins */}}
{{ range $.Param "reveal_hugo.plugins" }}
  {{ if reflect.IsMap . }}
    {{/*  we already have a plugin definition object  */}}
    {{ $plugins = $plugins | append . }}
  {{ else }}
    {{/*  convert from old string to new object format  */}}
    {{ $plug := dict "name" ( path.BaseName . ) "source" . }}
    {{ $plugins = $plugins | append $plug }}
  {{ end }}
{{ end }}

{{ $normalizedPlugins := slice }}
{{ range $plugins }}
  {{ $plugin_path := "" }}
  {{/*  try different sources of local plugin paths. They can be in the static dir,
        or the current content bundle. Setting the "local" attribute to true overrides
        the heuristic.
  */}}
  {{ if .local | default false }}
    {{ $plugin_path = .source }}
  {{ else if or (fileExists .source) (fileExists (path.Join "static" .source)) }}
    {{/*  file exists in content or static, use that  */}}
    {{ $plugin_path = .source }}
  {{ else }}
    {{/*  file exists on filesystem or in CDN use that  */}}
    {{ $plugin_path = path.Join $reveal_location .source }}
  {{ end }}

  {{ $normalizedPlugins = $normalizedPlugins | append (merge . (dict "source" $plugin_path)) }}
{{ end}}

{{ return $normalizedPlugins }}
